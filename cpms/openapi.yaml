openapi: 3.0.3
info:
  title: CPMS Host Program API
  version: 1.0.0
  description: |
    CPMS 客户端与主机端程序（内网数据服务进程）通信接口。
    仅局域网使用，不暴露互联网。
servers:
  - url: http://cpms-host.local/api/v1
tags:
  - name: Auth
  - name: AdminUsers
  - name: Archives
  - name: Biometrics
  - name: Materials
  - name: Audit
  - name: System

paths:
  /auth/login:
    post:
      tags: [Auth]
      summary: 管理员登录
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"

  /auth/refresh:
    post:
      tags: [Auth]
      summary: 刷新访问令牌
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /auth/logout:
    post:
      tags: [Auth]
      summary: 退出登录
      security:
        - bearerAuth: []
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /auth/change-password:
    post:
      tags: [Auth]
      summary: 修改本人密码
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [old_password, new_password]
              properties:
                old_password:
                  type: string
                new_password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /admin/users:
    get:
      tags: [AdminUsers]
      summary: 管理员列表（仅超级管理员）
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [ACTIVE, DISABLED, LOCKED]
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"
    post:
      tags: [AdminUsers]
      summary: 创建管理员（仅超级管理员）
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password, role]
              properties:
                username:
                  type: string
                password:
                  type: string
                role:
                  type: string
                  enum: [ADMIN]
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /admin/users/{user_id}/status:
    post:
      tags: [AdminUsers]
      summary: 禁用/启用管理员（仅超级管理员）
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status, confirm_password]
              properties:
                status:
                  type: string
                  enum: [ACTIVE, DISABLED]
                confirm_password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /admin/users/{user_id}/reset-password:
    post:
      tags: [AdminUsers]
      summary: 重置管理员密码（仅超级管理员）
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [new_password, confirm_password]
              properties:
                new_password:
                  type: string
                confirm_password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives:
    post:
      tags: [Archives]
      summary: 新建档案
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateArchiveRequest"
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"
    get:
      tags: [Archives]
      summary: 档案列表检索
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: archive_index_no
          schema:
            type: string
        - in: query
          name: passport_no
          schema:
            type: string
        - in: query
          name: full_name
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}:
    get:
      tags: [Archives]
      summary: 档案详情
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"
    put:
      tags: [Archives]
      summary: 更新档案
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateArchiveRequest"
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}/status:
    post:
      tags: [Archives]
      summary: 档案状态变更
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [ACTIVE, SUSPENDED, ARCHIVED]
                remark:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}/biometrics/photo:
    post:
      tags: [Biometrics]
      summary: 上传照片
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}/biometrics/fingerprint:
    post:
      tags: [Biometrics]
      summary: 上传指纹
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}/biometrics:
    get:
      tags: [Biometrics]
      summary: 生物资料列表
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /biometrics/{asset_id}:
    delete:
      tags: [Biometrics]
      summary: 删除生物资料（软删除）
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: asset_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /archives/{archive_id}/materials:
    post:
      tags: [Materials]
      summary: 上传档案材料
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [material_type, title, file]
              properties:
                material_type:
                  type: string
                title:
                  type: string
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"
    get:
      tags: [Materials]
      summary: 材料列表
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: archive_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /materials/{material_id}:
    delete:
      tags: [Materials]
      summary: 删除材料（软删除）
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: material_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /audit/logs:
    get:
      tags: [Audit]
      summary: 审计日志查询
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: action
          schema:
            type: string
        - in: query
          name: operator_user_id
          schema:
            type: string
        - in: query
          name: time_from
          schema:
            type: string
            format: date-time
        - in: query
          name: time_to
          schema:
            type: string
            format: date-time
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /system/backup:
    post:
      tags: [System]
      summary: 创建备份包
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_path, confirm_password]
              properties:
                target_path:
                  type: string
                confirm_password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /system/restore:
    post:
      tags: [System]
      summary: 导入恢复包
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, confirm_password]
              properties:
                file:
                  type: string
                  format: binary
                confirm_password:
                  type: string
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

  /system/backup-records:
    get:
      tags: [System]
      summary: 备份/恢复记录
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StandardResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    StandardResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: integer
          example: 0
        message:
          type: string
          example: ok
        data:
          nullable: true
        trace_id:
          type: string
          nullable: true
    LoginResponse:
      type: object
      required: [code, message, data]
      properties:
        code:
          type: integer
          example: 0
        message:
          type: string
          example: ok
        data:
          type: object
          required: [access_token, refresh_token, expires_in, user]
          properties:
            access_token:
              type: string
            refresh_token:
              type: string
            expires_in:
              type: integer
              example: 1800
            user:
              type: object
              required: [user_id, role]
              properties:
                user_id:
                  type: string
                role:
                  type: string
                  enum: [SUPER_ADMIN, ADMIN]
    CreateArchiveRequest:
      type: object
      required: [province_code, full_name, birth_date, gender_code, passport_no]
      properties:
        province_code:
          type: string
          pattern: "^[A-Z]{2}$"
          example: ZS
        full_name:
          type: string
          maxLength: 128
        birth_date:
          type: string
          format: date
          example: "1990-01-15"
        gender_code:
          type: string
          enum: [M, W]
        height_cm:
          type: number
          format: float
          example: 175.5
        passport_no:
          type: string
          maxLength: 32
    UpdateArchiveRequest:
      type: object
      properties:
        full_name:
          type: string
          maxLength: 128
        birth_date:
          type: string
          format: date
        gender_code:
          type: string
          enum: [M, W]
        height_cm:
          type: number
          format: float
        passport_no:
          type: string
          maxLength: 32
        remark:
          type: string
