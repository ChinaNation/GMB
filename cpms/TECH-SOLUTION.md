# CPMS 系统技术方案（离线内网版）

## 1. 文档目标
- 明确 `CPMS`（公民护照管理系统）的技术边界与落地方案。
- 统一“离线内网、主机集中存储、多客户端协同”的部署模式。
- 为后续 `DB-SCHEMA`、`API-SPEC`、实施计划提供基线。

## 2. 系统边界
- `CPMS` 与 `SFID` 为两套独立软件，业务与工程边界分离。
- `CPMS` 不连接互联网，仅在局域网内运行。
- `CPMS` 核心职责：
  - 存储与管理公民照片、指纹、档案材料。
  - 管理档案字段（姓名、出生日期、性别、身高、护照号、档案索引号等）。
  - 提供管理员登录、角色权限、审计追溯、备份恢复能力。

## 3. 业务与角色模型
### 3.1 账号类型
- 超级管理员（Super Admin）
  - 首次安装初始化创建。
  - 可创建/禁用/重置系统管理员。
  - 可管理角色策略、系统配置、备份恢复、全量审计。
- 系统管理员（Admin）
  - 登录后进行档案录入、查询、修改、归档、导出等授权操作。

### 3.2 登录边界
- 操作系统账号仅用于进入电脑，不等于 CPMS 权限。
- 业务权限由 CPMS 账号与角色决定。

## 4. 部署架构
## 4.1 总体拓扑
- 1 台内网主机：
  - 存放 CPMS 主数据库、附件、审计日志。
  - 运行主机端程序进程（仅内网监听）。
- N 台客户端（例如 20 台）：
  - 安装 CPMS 客户端程序。
  - 使用管理员账号连接主机并操作同一份数据。

## 4.2 网络原则
- 禁止外网访问，仅允许局域网访问。
- 主机端监听固定内网地址与端口。
- 客户端通过白名单网段访问。

## 5. 技术栈建议
- 客户端：`Tauri + React + TypeScript`
- 主机端程序（内网数据服务进程）：`Rust + Axum`
- 主数据存储：`PostgreSQL`（推荐）或 `SQLite`（仅低并发）
- 附件存储：主机本地加密目录（照片/指纹/材料）
- 日志与审计：本地文件 + 数据库存档

说明：
- 多客户端并发场景下，不建议共享盘直接并发读写单个 SQLite 文件。
- 建议主机端集中数据库，客户端仅通过内网 API 访问。

## 6. 核心功能模块
- `auth`：账号登录、密码策略、会话管理、失败锁定。
- `admin`：管理员生命周期管理（创建、禁用、重置密码、角色授权）。
- `archive`：公民档案主数据管理。
- `biometric`：照片与指纹文件管理（上传、替换、版本记录）。
- `material`：档案材料管理（分类、索引、状态）。
- `audit`：操作审计（登录、增删改、导入导出、权限变更）。
- `backup`：备份打包、导入恢复、完整性校验。

## 7. 档案索引号规范
- 规则：`省代码 + 性别码 + 生日码 + 档案编号`
- 省代码：两位大写字母（`[A-Z]{2}`），取值来源于 `primitives/src/sheng_code.rs` 的简称码字段（例如 `("中枢省", "ZS", "01_ZHONGSHU")` 中的 `ZS`）
- 性别码：`M`（男）/`W`（女）
- 生日码：`YYYYMMDD`
- 档案编号：建议 6 位数字流水号
- 推荐正则：`^[A-Z]{2}(M|W)[0-9]{8}[0-9]{6}$`

## 8. 数据设计原则
- 关键唯一约束：
  - `archive_index_no` 唯一
  - `passport_no` 唯一
- 敏感信息分级：
  - 公开字段、业务敏感字段、生物敏感字段分层存储与访问控制。
- 删除策略：
  - 档案和附件默认软删除，保留审计追踪。

## 9. 安全方案
- 认证安全：
  - 密码哈希使用 `Argon2id`。
  - 登录失败次数限制与临时锁定。
  - 会话超时与二次确认（高风险操作）。
- 数据安全：
  - 传输使用内网 TLS（可选但推荐）。
  - 数据库敏感列加密、附件文件加密存储。
- 审计安全：
  - 审计日志不可业务删除。
  - 关键日志可用哈希链增强防篡改。

## 10. 备份与恢复
## 10.1 备份目标
- 备份包复制到其他电脑后可恢复打开并继续使用。

## 10.2 备份包组成
- 数据库快照
- 照片/指纹/附件文件
- 配置与密钥元数据
- 版本与校验清单（manifest）

## 10.3 恢复流程
1. 在目标电脑安装同版本 CPMS 主机程序。
2. 导入备份包并执行完整性校验。
3. 使用超级管理员账号登录并验证核心数据。

## 11. 非功能目标
- 可用性：内网服务可用性 `>= 99.9%`
- 性能：常用查询接口 P95 `< 300ms`（内网环境）
- 审计：关键动作 100% 可追溯
- 运维：支持每日自动备份、手动即时备份、恢复演练

## 12. 实施分期
1. M1（基础可用）
- 登录认证、超级管理员初始化、管理员管理
- 档案录入查询、索引号规则校验、基础审计

2. M2（多端协同）
- 主机集中存储、20 台客户端并发访问
- 照片/指纹/附件全流程管理

3. M3（稳态运营）
- 备份包跨机恢复、审计加固、权限细化、报表导出

## 13. 关联文档
- 角色与部署说明：`cpms/ROLE-DEPLOYMENT.md`
