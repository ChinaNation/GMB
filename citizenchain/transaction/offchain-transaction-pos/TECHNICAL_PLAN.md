# Offchain Transaction POS 技术方案（定稿）

## 1. 目标与边界
- 本模块目标：支持省储行清算的链下交易批量上链。
- 业务终态发生在链下清算系统，不依赖上链成功。
- 上链打包是独立动作：用于链上记账/审计/对账。
- 上链手续费由省储行支付。

## 2. 业务模型（按制度定稿）
1. 收款方账户先绑定一个清算省储行（例如 G 省储行）。
2. 该交易手续费费率使用该省储行当前费率（制度范围内可治理配置）。
3. 用户付款时，链下系统即时完成并固化交易终态（不可更改）：
   - 付款方扣减：`amount + fee`
   - 收款方增加：`amount`
   - 省储行费用账户增加：`fee`
4. 交易链下确认后即结束，禁止修改、禁止冲正。
5. 省储行按时间/笔数阈值将“已确认链下交易”打包上链。

## 3. 示例（制度示例）
- 收款方 A 绑定 G 省储行。
- B 向 A 支付 1000 元。
- G 省储行费率 0.01%。
- 结果即时固定：
  - B 实付 1000.1
  - A 实收 1000.0
  - G 省储行得 0.1
  - B 余额减少 1000.1

## 4. 关键设计原则
- 清算终态与上链解耦：
  - 链下确认不等待上链。
  - 上链失败不回滚已确认清算。
- 不可变交易：
  - 已确认交易不可修改。
  - 错单由用户与商户线下协商后发起新交易，不在系统内冲正。
- 幂等防重：
  - 同一业务交易只能确认一次。
  - 打包与上链可重试但不得重复生效。
- 确认即终态（技术定义）：
  - 以单事务完成：三方余额变更 + 流水写入 + 状态置 `CONFIRMED`。
  - 事务提交成功即对外可见，不允许“确认后再改”。

## 5. 模块职责拆分
- 链下清算系统（新增/链下服务）负责：
  - 收款方绑定省储行
  - 实时清算并固化终态
  - 生成可上链批次数据
- `offchain-transaction-pos`（本模块）负责：
  - 验签、费率校验、防重
  - 批次上链执行
  - 批次摘要与状态落链

## 6. 数据对象（建议）
- `RecipientClearingBinding`（链下主存）
  - `recipient_account`
  - `institution`
  - `last_switch_block`
- `OffchainConfirmedTx`（链下主存）
  - `tx_id`
  - `institution`
  - `payer`
  - `recipient`
  - `amount`
  - `fee`
  - `confirmed_at`
  - `fee_rate_snapshot`（确认时费率快照）
  - `immutable = true`
- `PackOutbox`（链下主存）
  - `batch_seq`
  - `institution`
  - `items[]`
  - `retry_count`
  - `next_retry_at`
  - `status`

## 7. 处理流程
### 7.1 链下确认流程
1. 收款方查绑定省储行。
2. 取该省储行费率计算手续费。
3. 原子记账：付款方、收款方、省储行费用账户三方同时更新。
4. 写入不可变交易记录（状态 `CONFIRMED`）。
5. 返回实时结果给前端钱包。

### 7.2 打包上链流程
1. 省储行从已确认交易中按阈值组批。
2. 生成批次签名并提交到链上。
3. 链上执行批次并记录摘要。
4. 失败进入持久化重试队列，直到成功。

## 8. 失败与重试策略（必须成功）
- 使用持久化 Outbox 重试队列。
- 指数退避 + 最大间隔，不设失败终止态。
- 重试期间保持幂等，防止重复记账。
- 上链成功后回写链下 `PACKED` 状态。
- Outbox 必备字段：
  - `idempotency_key`（建议 `institution + batch_seq`）
  - `last_error`
  - `first_failed_at`
  - `last_retry_at`
- 失败重试不中断主链下清算，只影响“上链进度”。

## 9. 安全与一致性要求
- 交易确认必须可审计（trace_id、operator、签名摘要）。
- 所有确认交易必须可追溯到批次与链上摘要。
- 对账任务持续校验：链下确认总额 == 链上批次总额（按机构分桶）。
- 不可篡改约束（Append-only）：
  - `OffchainConfirmedTx` 仅允许 `INSERT`，禁止 `UPDATE/DELETE`。
  - DB 账号权限分离：清算写账号无删除/更新权限，运维账号无业务写权限。
  - 应用层二次防护：对已确认流水一律拒绝修改接口。

## 10. 与现有模块对接点
- 费率来源：沿用本模块内部治理费率。
- 打包阈值：沿用现有时间/笔数阈值。
- 上链手续费承担账户：沿用省储行手续费账户。
- 后续代码实现以本文件为唯一口径。

## 11. 待实现任务清单
1. 链下清算服务：账户绑定、实时清算、不可变流水。
2. 持久化 Outbox：批次构建与重试。
3. 对账服务：链下确认 vs 链上摘要。
4. 运维能力：失败告警、重试监控、审计查询接口。

## 12. 测试清单（必须覆盖）
1. 确认事务原子性：三方余额与流水状态同时成功/同时失败。
2. 重复提交同一交易：仅首笔生效，其余命中幂等返回。
3. 节点重启恢复：Outbox 重启后继续重试，不丢单、不重单。
4. 批次重复上报：链上/链下均不重复记账。
5. 网络抖动与超时：可持续重试直到成功。
6. 费率变更前后：历史交易按 `fee_rate_snapshot` 可追溯解释一致。
